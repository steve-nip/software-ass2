<!DOCTYPE html>
<html lang="en">

<head>
    <title>Image AI Dataset Annotation</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="style.css">
</head>

<body>

    <div class="container">
        <h1 class="main-title">
            <i class="bi bi-image-fill"></i> <span id="image-title">Image Details</span>
        </h1>

        <main>
            <nav aria-label="breadcrumb">
                <ul>
                    <li><a href="index.html"><i class="bi bi-house-door"></i> Home</a></li>
                    <li><a href="upload.html"><i class="bi bi-cloud-upload"></i> Upload Image</a></li>
                    <li><a href="labels.html"><i class="bi bi-tags"></i> Manage Labels</a></li>
                    <li><a href="images.html"><i class="bi bi-image"></i> Manage Images</a></li>
                </ul>
            </nav>

            <!-- Image Preview Section -->
            <section>
                <h2><i class="bi bi-eye"></i> Preview</h2>
                <p id="image-description" class="lead text-muted mb-4"></p>

                <div class="image-frame">
                    <img id="image-element" alt="Dataset image preview" hidden>
                </div>
            </section>

            <!-- Image delete section -->
            <section class="mt-4">
                <div class="d-flex justify-content-end">
                    <button id="delete-image-btn" class="btn btn-danger">
                        <i class="bi bi-trash"></i> Delete This Image
                    </button>
                </div>
            </section>

            <!-- Label Management Section -->
            <section>
                <h2><i class="bi bi-tags-fill"></i> Labels Management</h2>

                <div class="form-container">
                    <h3 class="form-subtitle"><i class="bi bi-plus-circle"></i> Assign New Label</h3>
                    <form id="assign-form" aria-describedby="form-status">
                        <div class="form-group">
                            <label for="label-select" class="form-label">
                                <i class="bi bi-tag"></i> Select Label
                            </label>
                            <div class="form-row">
                                <select id="label-select" name="label_id" class="form-select"></select>
                                <button type="submit" class="btn-gradient-primary">
                                    <i class="bi bi-plus-lg"></i> Add Label
                                </button>
                            </div>
                        </div>
                    </form>
                    <p id="form-status" role="status" aria-live="polite" class="status-message"></p>
                </div>

                <div class="labels-section">
                    <h3 class="form-subtitle"><i class="bi bi-list-check"></i> Assigned Labels</h3>
                    <ul class="data-list" id="assigned-labels"></ul>
                    <p id="labels-empty" class="alert-info" hidden>
                        <i class="bi bi-info-circle"></i> No Labels assigned yet. Add one above!
                    </p>
                </div>
            </section>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const params = new URLSearchParams(window.location.search);
        const imageId = Number(params.get('id'));
        const titleEl = document.getElementById('image-title');
        const descEl = document.getElementById('image-description');
        const imageEl = document.getElementById('image-element');
        const labelsList = document.getElementById('assigned-labels');
        const labelsEmpty = document.getElementById('labels-empty');
        const labelSelect = document.getElementById('label-select');
        const form = document.getElementById('assign-form');
        const statusEl = document.getElementById('form-status');

        if (!Number.isInteger(imageId) || imageId <= 0) {
            titleEl.textContent = 'Image Not Found';
            descEl.textContent = 'Invalid images ID.';
            descEl.style.color = '#dc3545';
            form.hidden = true;
            labelsEmpty.hidden = false;
            labelsEmpty.className = 'alert-danger';
            labelsEmpty.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Cannot load labels for invalid image.';
            throw new Error('Invalid image ID');
        }

        function renderAssignedLabels(labels) {
            labelsList.innerHTML = '';
            if (!labels || labels.length === 0) {
                labelsEmpty.hidden = false;
                return;
            }
            labelsEmpty.hidden = true;
            for (const label of labels) {
                const item = document.createElement('li');
                item.className = 'data-item';
                item.innerHTML = `
                <div class="label-info">
                    <span class="label-badge"><i class="bi bi-tag-fill"></i></span>
                    <div class="label-details">
                        <span class="primary">${label.name}</span>
                        <span class="secondary">
                            <i class="bi bi-clock"></i> Assigned ${new Date(label.annotation_time).toLocaleString()}
                        </span>
                    </div>
                </div>
                <button type="button" data-label-id="${label.label_id}" class="btn-danger">
                    <i class="bi bi-trash"></i> Remove
                </button>   
            `;
                labelsList.appendChild(item);
            }
        }

        async function loadLabelOptions() {
            try {
                const response = await fetch('/api/labels');
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to load labels');
                }
                labelSelect.innerHTML = '';
                if (!data.labels || data.labels.length === 0) {
                    const option = document.createElement('option');
                    option.textContent = 'No labels available - Create one first';
                    option.disabled = true;
                    option.selected = true;
                    labelSelect.appendChild(option);
                    form.querySelector('button[type="submit"]').disabled = true;
                    return;
                }

                form.querySelector('button[type="submit"]').disabled = false;
                const placeholder = document.createElement('option');
                placeholder.value = '';
                placeholder.textContent = 'Select a label...';
                placeholder.disabled = true;
                placeholder.selected = true;
                labelSelect.appendChild(placeholder);
                for (const label of data.labels) {
                    const option = document.createElement('option');
                    option.value = label.id;
                    option.textContent = label.name;
                    labelSelect.appendChild(option);
                }
            } catch (error) {
                statusEl.textContent = error instanceof Error ? error.message : String(error);
                statusEl.className = 'status-message error';
                form.querySelector('button[type="submit"]').disabled = true;
            }
        }

        async function loadImageDetails() {
            try {
                const response = await fetch(`/api/images/${imageId}`);
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to load image details');
                }

                titleEl.textContent = data.image.filename;
                descEl.innerHTML = `<i class="bi bi-calendar-event"></i> Uploaded on ${new Date(data.image.upload_time).toLocaleString()}`;
                imageEl.src = `/uploads/${encodeURIComponent(data.image.filename)}`;
                imageEl.hidden = false;
                renderAssignedLabels(data.labels);
            } catch (error) {
                titleEl.textContent = 'Image not found';
                descEl.textContent = error instanceof Error ? error.message : String(error);
                descEl.style.color = '#dc3545';
                imageEl.hidden = true;
                form.hidden = true;
                labelsEmpty.hidden = false;
                labelsEmpty.className = 'alert-danger';
                labelsEmpty.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Unable to load labels.';
            }
        }

        form.addEventListener('submit', async (event) => {
            event.preventDefault();
            const submitButton = form.querySelector('button[type="submit"]');
            const originalHTML = submitButton.innerHTML;
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="bi bi-hourglass-split"></i> Adding...';
            statusEl.textContent = '';
            statusEl.className = 'status-message';

            const labelId = Number(labelSelect.value);
            if (!Number.isInteger(labelId)) {
                statusEl.textContent = 'Please choose a label first.';
                statusEl.className = 'status-message warning';
                submitButton.disabled = false;
                submitButton.innerHTML = originalHTML;
                return;
            }

            try {
                const response = await fetch(`/api/images/${imageId}/labels`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ label_id: labelId }),
                });
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to assign label');
                }
                statusEl.innerHTML = '<i class="bi bi-check-circle"></i> Label assigned successfully!';
                statusEl.className = 'status-message success';
                labelSelect.value = '';
                await loadImageDetails();

                setTimeout(() => {
                    statusEl.textContent = '';
                    statusEl.className = 'status-message';
                }, 3000);
            } catch (error) {
                statusEl.innerHTML = `<i class="bi bi-exclamation-triangle"></i> Error: ${error instanceof Error ? error.message : String(error)}`;
                statusEl.className = 'status-message error';
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = originalHTML;
            }
        });

        labelsList.addEventListener('click', async (event) => {
            const target = event.target.closest('.btn-danger');
            if (!target) return;

            const labelId = Number(target.dataset.labelId);
            if (!Number.isInteger(labelId)) return;

            const originalHTML = target.innerHTML;
            target.disabled = true;
            target.innerHTML = '<i class="bi bi-hourglass-split"></i>';

            try {
                const response = await fetch(`/api/images/${imageId}/labels/${labelId}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to remove label');
                }
                statusEl.innerHTML = '<i class="bi bi-check-circle"></i> Label removed successfully!';
                statusEl.className = 'status-message success';
                await loadImageDetails();

                setTimeout(() => {
                    statusEl.textContent = '';
                    statusEl.className = 'status-message';
                }, 3000);
            } catch (error) {
                statusEl.innerHTML = `<i class="bi bi-exclamation-triangle"></i> Error: ${error instanceof Error ? error.message : String(error)}`;
                statusEl.className = 'status-message error';
                target.disabled = false;
                target.innerHTML = originalHTML;
            }
        });

        Promise.all([loadLabelOptions(), loadImageDetails()]).catch((error) => {
            statusEl.textContent = error instanceof Error ? error.message : String(error);
            statusEl.className = 'status-message error';
        });

        
        const deleteBtn = document.getElementById('delete-image-btn');

        if (deleteBtn) {
            deleteBtn.addEventListener('click', async () => {
                if (!confirm('Are you sure you want to permanently delete this image?\nAll associated labels will also be removed.')) {
                    return;
                }

                deleteBtn.disabled = true;
                deleteBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Deleting...';

                try {
                    const response = await fetch(`/api/images/${imageId}`, {
                        method: 'DELETE'
                    });

                    if (!response.ok) {
                        const data = await response.json();
                        throw new Error(data.error || 'Delete failed');
                    }

                    statusEl.innerHTML = '<i class="bi bi-check-circle"></i> Image deleted successfully! Redirecting...';
                    statusEl.className = 'status-message success';

                    // 3秒後跳回首頁
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 3000);

                } catch (error) {
                    statusEl.innerHTML = `<i class="bi bi-exclamation-triangle"></i> Error: ${error.message}`;
                    statusEl.className = 'status-message error';
                    deleteBtn.disabled = false;
                    deleteBtn.innerHTML = '<i class="bi bi-trash"></i> Delete This Image';
                }
            });
        }
    </script>
</body>

</html>