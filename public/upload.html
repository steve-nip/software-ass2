<!DOCTYPE html>
<html lang="en">

<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Upload Image - AI Dataset Annotator</title>
<!-- Bootstrap 5 CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
<link rel="stylesheet" href="style.css">
</head>

<body>
<div class="container">
  <h1 id="main-title" class="main-title">
    <i class="bi bi-cloud-upload"></i> Upload Image
  </h1>

  <nav aria-label="breadcrumb">
    <ul>
      <li><a href="index.html"><i class="bi bi-house-door"></i> Home</a></li>
      <li><a href="upload.html"><i class="bi bi-cloud-upload"></i> Upload Image</a></li>
      <li><a href="labels.html"><i class="bi bi-tags"></i> Manage Labels</a></li>
      <li><a href="images.html"><i class="bi bi-image"></i> View Images</a></li>
    </ul>
  </nav>

  <!-- Upload Image Section -->
  <section class="upload-section" id="upload-image">
    <h2><i class="bi bi-cloud-arrow-up"></i> Upload Image</h2>
    <form id="upload-form" aria-describedby="status">
      <div class="mb-3">
        <label for="imageUpload" class="form-label"></label>
        <div id="fileUploadWrapper" type="file" name="image" accept="image/*" required class="form-control">
          <h1 id="main-title" class="main-title">
            <i class="bi bi-cloud-upload"></i> Upload
          </h1>
        </div>
        <input id="imageUpload" type="file" name="image" accept="image/*" required class="form-control">

      </div>

      <div class="mb-3">
        <label for="labelSelect" class="form-label">Select label</label>
        <select id="labelSelect" name="label" class="form-select" aria-label="Select label for image" required>
          <option value="" disabled selected>Loading labels...</option>
        </select>
      </div>
      <div id="fileName"></div>

      <button type="submit" class="btn btn-gradient-primary" id="uploadBtn">
        <i class="bi bi-upload"></i> Upload
      </button>
    </form>
    <p id="status" class="status" role="status" aria-live="polite"></p>
  </section>

  <div class="card mb-3 card-gradient-blue">
    <div class="card-body">
      <h2><i class="bi bi-info-circle"></i> Upload Guidelines</h2>
      <ul>
        <li><strong>File Size Limit</strong>: Maximum 10MB per image</li>
        <li><strong>Label Requirement</strong>: Please select a label before uploading</li>
      </ul>
    </div>
  </div>

  <button id="backToTop" class="btn-back-to-top" aria-label="back to top" title="back to top">
    <div class="btn-content">
      <i class="bi bi-arrow-up-circle-fill"></i>
      <span class="btn-text">
        <h2>TOP</h2>
      </span>
    </div>
    <div class="btn-ripple"></div>
    <div class="btn-progress"></div>
  </button>

</div>

<!-- Bootstrap 5 JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>

  const form = document.getElementById('upload-form');
  const status = document.getElementById('status');
  const fileInput = document.getElementById('imageUpload');
  const fileUploadWrapper = document.getElementById('fileUploadWrapper');
  const fileName = document.getElementById('fileName');
  const labelSelect = document.getElementById('labelSelect');
  const MAX_FILE_SIZE = 10 * 1024 * 1024;

  // 載入 labels
  async function loadLabels() {
    try {
      const response = await fetch('/api/labels');
      const data = await response.json();

      // 清空選項
      labelSelect.innerHTML = '<option value="" disabled selected>Select a label</option>';

      // 添加 labels
      if (data.labels && data.labels.length > 0) {
        data.labels.forEach(label => {
          const option = document.createElement('option');
          option.value = label.id;
          option.textContent = label.name;
          labelSelect.appendChild(option);
        });
      } else {
        labelSelect.innerHTML = '<option value="" disabled selected>No labels available</option>';
      }
    } catch (error) {
      console.error('Error loading labels:', error);
      labelSelect.innerHTML = '<option value="" disabled selected>Error loading labels</option>';
    }
  }

  // 頁面載入時執行
  loadLabels();

  fileUploadWrapper.addEventListener('click', () => {
    fileInput.click();
  });

  fileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
      fileName.textContent = file.name;
    }
  });

  fileUploadWrapper.addEventListener('dragover', (e) => {
    e.preventDefault();
    fileUploadWrapper.classList.add('dragover');
  });

  fileUploadWrapper.addEventListener('dragleave', () => {
    fileUploadWrapper.classList.remove('dragover');
  });

  fileUploadWrapper.addEventListener('drop', (e) => {
    e.preventDefault();
    fileUploadWrapper.classList.remove('dragover');
    const files = e.dataTransfer.files;
    if (files.length > 0) {
      fileInput.files = files;
      fileName.textContent = files[0].name;
    }
  });

  form.addEventListener('submit', async (event) => {
    event.preventDefault();
    status.textContent = '';
    const submitButton = form.querySelector('button[type="submit"]');
    submitButton.disabled = true;

    try {
      const file = fileInput.files[0];

      console.log(file)
      console.log('Selected label ID:', labelSelect.value);

      if (file.size > MAX_FILE_SIZE) {
        throw new Error(`File size exceeds 10MB limit. Your file is ${(file.size / 1024 / 1024).toFixed(2)}MB`);
      }

      const formData = new FormData();
      formData.append('image', file);
      formData.append('label_id', labelSelect.value);  // 改成 label_id

      const response = await fetch('/api/uploads', {
        method: 'POST',
        body: formData
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || 'Upload failed');
      }

      form.reset();
      fileName.textContent = '';
      status.textContent = `Upload complete. Image ID: ${data.image_id}`;
      status.style.color = 'green';
      status.style.background = '#d4edda';

      if (data.url) {
        const img = document.createElement('img');
        img.src = data.url;
        img.style.maxWidth = '100%';
        img.style.marginTop = '10px';
        img.style.borderRadius = '8px';
        status.appendChild(document.createElement('br'));
        status.appendChild(img);
      }
    } catch (error) {
      status.textContent = `Error: ${error instanceof Error ? error.message : String(error)}`;
      status.style.color = '#721c24';
      status.style.background = '#f8d7da';
    } finally {
      submitButton.disabled = false;
    }
  });

  const backToTopButton = document.getElementById('backToTop');

  window.addEventListener('scroll', () => {
    if (window.pageYOffset > 100) {
      backToTopButton.style.display = 'flex';
    } else {
      backToTopButton.style.display = 'none';
    }
  });

  backToTopButton.addEventListener('click', () => {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });
</script>
</body>

</html>